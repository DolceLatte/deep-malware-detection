import json
import os
import pickle
from collections import defaultdict

import pefile

from utils import load_files


def clean_name(section_name):
    section = str(section_name).split("\\")[0]
    start_idx = section.find(".")
    return section[start_idx:]


def _summarize(data):
    for key, value in data.items():
        print(f"{key}: {len(value)}")


def main():
    sections = defaultdict(int)
    for directory in ("normal", "malware"):
        cwd = os.path.join("raw", directory)
        for file_name in os.listdir(cwd):
            # try:
            data = {}
            try:
                file = pefile.PE(os.path.join(cwd, file_name))
            except pefile.PEFormatError:
                pass
            for section in file.sections:
                name = clean_name(section.Name)
                data[name] = list(section.get_data())
                sections[name] += 1
            with open(f"./data/{directory}/{file_name}.pickle", "wb") as f:
                pickle.dump(data, f, protocol=pickle.HIGHEST_PROTOCOL)
            # except:
            #     pass
    with open("./data/sections.json", "w+") as f:
        json.dump(dict(sections), f)


if __name__ == "__main__":
    main()
