import os
import random

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import seaborn as sns
import torch
from sklearn.metrics import confusion_matrix
from tqdm.auto import tqdm


def set_seed(seed):
    random.seed(seed)
    os.environ["PYTHONHASHSEED"] = str(seed)
    np.random.seed(seed)
    torch.manual_seed(seed)
    if torch.cuda.is_available():
        torch.backends.cudnn.deterministic = True
        torch.backends.cudnn.benchmark = True


def count_parameters(model, trainable_only=True):
    if trainable_only:
        return sum(p.numel() for p in model.parameters() if p.requires_grad)
    return sum(p.numel() for p in model.parameters())


def set_plt_style():
    plt.rcParams.update(
        {"text.usetex": True, "font.family": "serif", "font.serif": ["cm"],}
    )


def plot_confusion_matrix(model, test_loader, save_title, device, normalize="all"):
    y_true, y_pred = predict(model, test_loader, device)
    conf_mat = confusion_matrix(y_true, y_pred, normalize=normalize)
    axis_labels = ("Benign", "Malware")
    df = pd.DataFrame(conf_mat, index=axis_labels, columns=axis_labels)
    plot = sns.heatmap(df, annot=True, cmap="Blues")
    plot.figure.savefig(os.path.join("figs", f"{save_title}.png"), dpi=300)


@torch.no_grad()
def predict(model, data_loader, device, to_numpy=True):
    model.eval()
    y_true = []
    y_pred = []
    for inputs, labels in tqdm(data_loader):
        inputs = inputs.to(device)
        outputs = model(inputs)
        outputs = outputs > 0
        y_true.append(labels)
        y_pred.append(outputs)
    y_true = torch.cat(y_true).to(int).to(device)
    y_pred = torch.cat(y_pred).to(int).to(device)
    if to_numpy:
        y_true = y_true.cpu().numpy()
        y_pred = y_pred.cpu().numpy()
    assert y_true.shape == y_pred.shape
    model.train()
    return y_true, y_pred


def get_accuracy(model, data_loader, device):
    y_true, y_pred = predict(model, data_loader, device, to_numpy=False)
    sample_size = y_true.size(0)
    return 100 * (y_true == y_pred).sum().item() / sample_size


def plot_train_history(loss_history, acc_history, save_title):
    fig, ax_left = plt.subplots()
    ax_right = ax_left.twinx()
    time_ = range(len(loss_history))
    ax_left.set_xlabel("Epochs")
    ax_left.set_ylabel("BCE Loss")
    ax_left.grid(linestyle="--")
    ax_left.plot(time_, loss_history, color="blue")
    ax_left.tick_params(axis="y")
    ax_right.set_ylabel("Val Acc")
    ax_right.plot(time_, acc_history, color="red")
    ax_right.tick_params(axis="y")
    fig.tight_layout()
    fig.savefig(os.path.join("figs", f"{save_title}_train_history.png"), dpi=300)
